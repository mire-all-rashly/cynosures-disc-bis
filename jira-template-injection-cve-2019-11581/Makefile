net := jira-template-injection-cve-2019-11581
hp  := jira-server
sc  := jira-smtp

build:
	-docker network remove $(net)
	docker network create $(net)
	docker build -t $(hp) $(hp)/.
	docker build -t $(sc) $(sc)/.

run_opts := --rm -it --network $(net) --dns-search=$(net)

drun_hp := docker run $(run_opts) --hostname $(hp).$(net) --name $(hp) $(hp)
dces_hp := docker container exec -it $(hp) python /app/mechanize-jira.py
drun_sc := docker run $(run_opts) --hostname $(sc).$(net) --name $(sc) $(sc)
dces_sc := docker container exec -it $(sc) ncat -l 12345

run:
	tmux new-session -d "/bin/sh -c '$(drun_hp); exec bash'"
	tmux split-window -v "/bin/sh -c '$(drun_sc); exec bash'"
	sleep 10
	tmux split-window -h "/bin/sh -c '$(dces_sc); exec bash'"
	tmux split-window -h -t 0 "/bin/sh -c '$(dces_hp); exec bash'"
	tmux attach
	-docker network remove $(net)

clean:
	-docker network remove $(net)
	-docker container rm $(hp) $(sc)
	-docker image rm $(hp) $(sc)

