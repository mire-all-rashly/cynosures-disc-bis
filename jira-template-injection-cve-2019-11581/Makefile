net := jira-template-injection-cve-2019-11581
hp  := jira-server
sc  := jira-smtp

build:
	-docker network remove $(net)
	docker network create $(net)
	docker build -t $(hp) $(hp)/.
	docker build -t $(sc) $(sc)/.

run_opts := --rm -it --network $(net) --dns-search=$(net)

drun_hp := docker run $(run_opts) --hostname $(hp).$(net) --name $(hp) $(hp)
drun_sc := docker run $(run_opts) --hostname $(sc).$(net) --name $(sc) $(sc)

run:
	tmux new-session -d "/bin/sh -c '$(drun_hp); exec bash'"
	tmux split-window -v "/bin/sh -c '$(drun_sc); exec bash'"
	tmux attach
	-docker network remove $(net)

clean:
	-docker network remove $(net)
	-docker container rm $(hp) $(sc)
	-docker image rm $(hp) $(sc)

