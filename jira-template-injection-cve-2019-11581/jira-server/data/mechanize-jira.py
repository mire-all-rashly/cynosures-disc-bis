#!/usr/bin/python

import mechanize

url="http://jira-server:8080/"
user_pass="admin"
# Generic trial key: https://my.atlassian.com/license/evaluation
key=""

br = mechanize.Browser()
br.set_handle_robots(False)
br.open(url)

print "Setting setup mode"
br.select_form(nr=0)
print br.form
br.form.find_control('setupOption').readonly = False
br.form['setupOption'] = 'classic'
br.submit()
print "Done"

print "Setting DB mode"
br.select_form(nr=0)
print br.form
br.form['databaseOption'] = ['internal']
br.submit()
print "Done"

print "Setting JIRA base URL"
br.select_form(nr=0)
print br.form
br.form['baseURL'] = url
br.submit()
print "Done"

print "Setting license key"
br.select_form(nr=0)
print br.form
br.select_form(nr=1)
print br.form
br.form['setupLicenseKey'] = key
br.submit()
print "Done"

print "Setting admin user"
br.select_form(nr=0)
print br.form
br.form['fullname'] = "admin"
br.form['email'] = "root@jira-smtp"
br.form['username'] = user_pass
br.form['password'] = user_pass
br.form['confirm'] = user_pass
res = br.submit()
content = res.read()
print "Done"

print "Setting smtp server"
br.select_form(nr=0)
print br.form
br.form['noemail'] = ["false"]
br.form['serverName'] = "jira-smtp"
br.form['port'] = "25"
br.submit()
print "Done"

print "Logging in"
br.open(url + "login.jsp")
br.select_form(nr=1)
print br.form
br.form['os_username'] = user_pass
br.form['os_password'] = user_pass
br.submit()
print "Done"

#print "If too slow, need to get admin again"
#br.open(url + "/secure/admin/ViewApplicationProperties.jspa")
#br.select_form(nr=1)
#print br.form
#br.form['webSudoPassword'] = user_pass
#br.submit()

print "Enabling admin contact"
br.open(url + "EditApplicationProperties!default.jspa")
br.select_form(nr=1)
print br.form
br.form['showContactAdministratorsForm'] = ['true']
br.submit()
print "Done"

print "All done"
